<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Test - Enhanced V3</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .search-section {
            margin-bottom: 30px;
        }
        .search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .search-input:focus {
            outline: none;
            border-color: #0066cc;
        }
        .search-button {
            margin-top: 10px;
            padding: 12px 30px;
            font-size: 16px;
            background: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .search-button:hover {
            background: #0052a3;
        }
        .search-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results-section {
            margin-top: 30px;
        }
        .result-item {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            border-left: 4px solid #0066cc;
        }
        .result-title {
            font-size: 20px;
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 10px;
        }
        .result-score {
            float: right;
            background: #0066cc;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .result-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .result-debug {
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            color: #666;
        }
        .debug-label {
            font-weight: bold;
            color: #444;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .status {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .search-options {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .option-group {
            margin-bottom: 10px;
        }
        .option-group label {
            display: inline-block;
            margin-right: 20px;
            cursor: pointer;
        }
        .option-group input[type="radio"] {
            margin-right: 5px;
        }
        .word-analysis {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 4px;
            font-size: 12px;
        }
        .word-weights {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .word-weight-item {
            padding: 5px 10px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 11px;
        }
        .ignored-word {
            background: #ffebee;
        }
        .downweighted-word {
            background: #fff8e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Search Test - Enhanced V3</h1>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <div class="search-section">
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="Enter search query..."
                value="government dashboard"
            >
            <button id="searchButton" class="search-button" disabled>Search</button>
        </div>
        
        <div id="wordAnalysis" class="word-analysis" style="display: none;">
            <div class="debug-label">Query Word Analysis:</div>
            <div id="wordBreakdown"></div>
        </div>
        
        <div id="results" class="results-section"></div>
    </div>

    <script>
        // Stop words to ignore completely
        const STOP_WORDS = new Set([
            // Articles
            'a', 'an', 'the',
            // Prepositions
            'for', 'with', 'to', 'from', 'by', 'at', 'in', 'on', 'of', 'about', 
            'through', 'during', 'before', 'after', 'above', 'below', 'up', 'down',
            'between', 'under', 'over', 'into', 'onto', 'upon', 'within', 'without',
            // Conjunctions
            'and', 'or', 'but', 'nor', 'yet', 'so', 'as',
            // Common adverbs
            'more', 'less', 'very', 'too', 'quite', 'just', 'only', 'even',
            // Pronouns and other common words
            'it', 'its', 'this', 'that', 'these', 'those', 'their', 'our', 'your',
            'we', 'us', 'them', 'they', 'he', 'she', 'him', 'her',
            'is', 'are', 'was', 'were', 'been', 'be', 'being',
            'has', 'have', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should',
            'may', 'might', 'must', 'can', 'shall',
            'not', 'no', 'yes'
        ]);

        // Common design words to downweight
        const COMMON_DESIGN_WORDS = new Set([
            'design', 'designed', 'designing', 'designer', 'designs',
            'create', 'created', 'creating', 'creative',
            'build', 'built', 'building', 'builder',
            'develop', 'developed', 'developing', 'developer', 'development',
            'make', 'made', 'making', 'maker',
            'project', 'projects',
            'work', 'worked', 'working', 'works'
        ]);

        const COMMON_WORD_WEIGHT = 0.3; // Weight for common design words

        let searchData = null;
        let currentSearchFunction = null;

        // Load search index on page load
        async function loadSearchIndex() {
            const indexPath = `/static/search-index.json`;
            
            updateStatus('Loading search index...');
            
            try {
                const response = await fetch(indexPath);
                if (!response.ok) {
                    throw new Error(`Failed to load index: ${response.status}`);
                }
                
                searchData = await response.json();
                
                // Load the search module
                const module = await import('/src/utils/enhanced-search.js');
                currentSearchFunction = module.performEnhancedSearch;
                
                updateStatus(`Loaded ${searchData.projects.length} projects from index`);
                document.getElementById('searchButton').disabled = false;
                
            } catch (error) {
                console.error('Error loading search index:', error);
                updateStatus(`Error: ${error.message}`, 'error');
            }
        }

        function updateStatus(message, type = 'success') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            statusEl.className = type === 'error' ? 'error' : 'status';
        }

        function analyzeQueryWords(query) {
            const words = query.toLowerCase().split(/\s+/).filter(w => w.length > 0);
            const analysis = {
                ignored: [],
                downweighted: [],
                normal: []
            };

            words.forEach(word => {
                if (STOP_WORDS.has(word)) {
                    analysis.ignored.push(word);
                } else if (COMMON_DESIGN_WORDS.has(word)) {
                    analysis.downweighted.push({ word, weight: COMMON_WORD_WEIGHT });
                } else {
                    analysis.normal.push({ word, weight: 1.0 });
                }
            });

            return analysis;
        }

        function displayWordAnalysis(analysis) {
            const container = document.getElementById('wordAnalysis');
            const breakdown = document.getElementById('wordBreakdown');
            
            let html = '<div class="word-weights">';
            
            if (analysis.ignored.length > 0) {
                html += '<div class="debug-label">Ignored words:</div>';
                analysis.ignored.forEach(word => {
                    html += `<div class="word-weight-item ignored-word">${word} (ignored)</div>`;
                });
            }
            
            if (analysis.downweighted.length > 0) {
                html += '<div class="debug-label">Downweighted words:</div>';
                analysis.downweighted.forEach(({ word, weight }) => {
                    html += `<div class="word-weight-item downweighted-word">${word} (${weight}x)</div>`;
                });
            }
            
            if (analysis.normal.length > 0) {
                html += '<div class="debug-label">Normal weight words:</div>';
                analysis.normal.forEach(({ word, weight }) => {
                    html += `<div class="word-weight-item">${word} (${weight}x)</div>`;
                });
            }
            
            html += '</div>';
            breakdown.innerHTML = html;
            container.style.display = 'block';
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query || !searchData || !currentSearchFunction) return;

            updateStatus('Searching...');
            
            // Analyze query words
            const wordAnalysis = analyzeQueryWords(query);
            displayWordAnalysis(wordAnalysis);
            
            // Filter query for search
            const filteredWords = [
                ...wordAnalysis.normal.map(w => w.word),
                ...wordAnalysis.downweighted.map(w => w.word)
            ];
            const filteredQuery = filteredWords.join(' ');

            try {
                // Pass word weights to search function
                const wordWeights = {};
                wordAnalysis.downweighted.forEach(({ word, weight }) => {
                    wordWeights[word] = weight;
                });

                const results = await currentSearchFunction(
                    filteredQuery, 
                    searchData,
                    { wordWeights } // Pass weights as options
                );
                
                displayResults(results, query);
                updateStatus(`Found ${results.results.length} results`);
                
            } catch (error) {
                console.error('Search error:', error);
                updateStatus(`Search error: ${error.message}`, 'error');
            }
        }

        function displayResults(searchResults, originalQuery) {
            const resultsDiv = document.getElementById('results');
            const { results, searchAnalysis } = searchResults;
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="result-item">No results found</div>';
                return;
            }

            let html = '';
            
            // Show search analysis if available
            if (searchAnalysis) {
                html += '<div class="result-item">';
                html += '<div class="result-title">Search Analysis</div>';
                html += '<div class="result-debug">';
                if (searchAnalysis.domain) html += `<div><span class="debug-label">Domain:</span> ${searchAnalysis.domain}</div>`;
                if (searchAnalysis.product) html += `<div><span class="debug-label">Product:</span> ${searchAnalysis.product}</div>`;
                if (searchAnalysis.goal) html += `<div><span class="debug-label">Goal:</span> ${searchAnalysis.goal}</div>`;
                html += '</div></div>';
            }

            // Show results
            results.forEach((result, index) => {
                html += `
                    <div class="result-item">
                        <div class="result-title">
                            <span class="result-score">#${index + 1} - Score: ${result.score.toFixed(1)}</span>
                            ${result.title}
                        </div>
                        <div class="result-description">${result.snippet || result.description || 'No description available'}</div>
                        <div class="result-debug">
                            <div><span class="debug-label">ID:</span> ${result.id}</div>
                            <div><span class="debug-label">Keywords found:</span> ${result.debug?.keywordsFound?.join(', ') || 'N/A'}</div>
                            ${result.debug?.keywordScore ? `<div><span class="debug-label">Keyword Score:</span> ${result.debug.keywordScore.toFixed(2)}</div>` : ''}
                            ${result.debug?.structuredScore ? `<div><span class="debug-label">Structured Score:</span> ${result.debug.structuredScore.toFixed(2)}</div>` : ''}
                            ${result.debug?.skillScore ? `<div><span class="debug-label">Skill Score:</span> ${result.debug.skillScore.toFixed(2)}</div>` : ''}
                            ${result.debug?.snippetSource ? `<div><span class="debug-label">Snippet Source:</span> ${result.debug.snippetSource}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        // Event listeners
        document.getElementById('searchButton').addEventListener('click', performSearch);
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // Load index on page load
        window.addEventListener('DOMContentLoaded', loadSearchIndex);
    </script>
</body>
</html> 